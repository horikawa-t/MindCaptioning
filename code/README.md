# Code for reproducing the results
- Decoding and encoding analyses were implemented by MATLAB. See [README.md](./matlab/README.md) in the matlab directory.
- Text generation analysis was implemented by Python. See [README.md](./python/README.md) in the python directory.
- Reproducing the figures in our manuscript was also implemented by MATLAB.

## Decoding and encoding analyses
- We implemented the decoding and encoding analyses using MATLAB (tested by MATLAB version 9.7, R2019b).
- Preprocessed fMRI data and features should be located in specified directory in MindCaptioning/data/{fmri/feature}.
- See [README.md](../../data/README.md) in the data directory for the detailes of data structures.

### Analysis
- Run the following script in MATLAB.
```plaintext
>> mcap_encoding_analysis
>> mcap_decoding_analysis
```
- Each of the encoding and decoding analysis can be performed with multiple CPUs in parallel.
- The encoding results are required for the decoding analysis (for voxel selection).
- Using multiple CPUs is strongly recommended for the entire analysis, as the encoding analysis will take about 1 week and the decoding analysis about 50 weeks to complete if using a single CPU.
- All results will be saved in [MindCaptioning/res/](../res) directory.
- The resultant decoded features will be used in the text generation analysis implemented by [Python](../python).
- Whole brain decoding results can be downloaded from figshare without performing the analysis by yourself:
 <a href="https://doi.org/10.6084/m9.figshare.25808179">figshare</a>
 (<a href="https://figshare.com/ndownloader/files/46420294">decfeat_wb.zip</a>). After downloading, unzip the file and place it in the [MindCaptioning/res/decoding](../res/decoding) directory.

### Evaluation
- Run the following script in MATLAB after completing the encoding analysis.
```plaintext
>> mcap_summary_encoding
```
- This script generates result figures in Fig. 3.
- You can download subsets of the encoding results from figshare without performing the analysis by yourself:
 <a href="https://doi.org/10.6084/m9.figshare.25808179">figshare</a>
 (<a href="https://figshare.com/ndownloader/files/46420405">res_encoding.zip</a>). After downloading, unzip the file and place it in the [MindCaptioning/res/encoding](../res/encoding) directory.

### Summary of text generation results
- Run the following script in MATLAB after completing the text generation analysis.
```plaintext
>> mcap_summary_decoding
```
- This script generates result figures in Fig. 2 and 4.
- You can download subsets of the text generation results from <a href="https://doi.org/10.6084/m9.figshare.25808179">figshare</a> (<a href="https://figshare.com/ndownloader/files/46422523">res_textgen.zip</a>) without having to perform the analysis yourself. After downloading, unzip the file and place it in the [MindCaptioning/res/text_generation](../res/text_generation) directory.


## Text generation analysis
- We implemented the text generation analysis using Python.
- Results of feature decoding are required for generating descriptions from the brain.

### Setup instructions
- Run the following command to set up and activate the conda enviroment (named 'mcap_demo').
```plaintext
>> sh ./setup.sh
>> source activate mcap_demo
```
- For Linux: Tested Ubuntu 20.04.6 and 22.04.1 with NVIDIA GPU.
- For Mac: Tested macOS Monterey version 1.12.1.
- For a list of installed library versions on Linux, see [./python/version_info.txt](./python/version_info.txt).
- The installation process will take a few minutes.

### Demo
- You can use our method to reconstruct arbitrary word sequences from semantic features (e.g., "May the Force be with you.").
- For a quick demo, see [./python/mcap_demo.ipynb](./python/mcap_demo.ipynb)ï¼Ž

### Analysis
- To reproduce the main results in our manuscript, run the following script after activating the environment ('mcap_demo').
```plaintext
>> source activate mcap_demo
>> python mcap_analysis.py
>> python mcap_evaluation.py
```
- This analysis requires decoding results generated using our [MATLAB code](./matlab).
- You can download whole brain (generalization) decoding results from figshare without performing the analysis by yourself: <a href="https://doi.org/10.6084/m9.figshare.25808179">figshare</a>
 (<a href="https://figshare.com/ndownloader/files/46420294">decfeat_wb.zip</a>). After downloading, unzip the file and place it in the [MindCaptioning/res/decoding](../res/decoding) directory.

- Using multiple GPUs is strongly recommended for the entire analysis, as the text generation analysis will take about 30 days to complete a single ROI analysis if using a single GPU.
- mcap_evaluation.py requies results generated by mcap_analysis.py.

- After completing the analysis, result figures can be generated using our [MATLAB code](./matlab). Please see using our [README.md](./matlab/README.md) in the directory.
- You can also download subsets of the results for drawing figures from <a href="https://doi.org/10.6084/m9.figshare.25808179">figshare</a> (<a href="https://figshare.com/ndownloader/files/46422523">res_textgen.zip</a>) without having to perform the analysis yourself.


### Note
- Although the script can run without a GPU, it will take an extremely long time for computation.
